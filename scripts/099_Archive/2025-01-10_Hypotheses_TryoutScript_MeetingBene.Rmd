---
title: "2024-08-14_Hypothesis1_MultilevelModel"
date: "`r Sys.Date()`"
output: 
  html_document: 
    theme: cosmo
    toc: yes
    toc_float: yes
---

**Attentional Biases in OCD**  
**Script Part II / ?**  
**Date: 24.07.2024**  
**Version: Version 2**  

# Description
This is the main analysis file of the 044_EYE project on Attentional Biases in OCD. This script includes the multilevel model that aims to test the main hypotheses. Furthermore, this script contains tests of the assumptions of multilevel models as well as descriptive plots. 

**Install Packages**
```{r install packages, message=F, warning=F, include=F}
# install.packages("ROCR")
# install.packages("lavaan")
# install.packages("psych")               # for basic calculations
# install.packages("foreign")             # xxx
# install.packages("ggplot2")             # for figures
# install.packages("car")                 # xxx
# install.packages("corpcor")             # for correlations
# install.packages("Hmisc")               # xxx
# install.packages("polycor")             # xxx
# install.packages("apaTables")           # for exporting tables according to APA style
# install.packages("QuantPsyc")           # xxx
# install.packages("effsize")             # xxx
# install.packages("tidyverse")           # for transforming data
# install.packages("readxl")              # for loading and exporting datasets
# install.packages("writexl")             # for loading and exporting datasets
# install.packages("bannerCommenter")     # for section headers
# install.packages("reshape2")            # for reshaping datasets
# install.packages("responsePatterns")    # for check of response patterns
# install.packages("corrplot")            # for correlation tables
# install.packages("gsubfn")              # for subsetting strings
# install.packages("data.table")          # for creating data tables
# install.packages("RColorBrewer")        # for colours in plots
# install.packages("pals")                # for colours in plots
# install.packages("devtools")
# install.packages("usethis")
# install.packages("lavaan")              # required to run SEMs
# install.packages("lavModel")            # required to run SEMs
# install.packages("ROCR")                # required to create ROC curves
# install.packages("hdf5r")
# install.packages("edfReader")           # required to read edf files
# install.packages("githubinstall")       # required to install packages from github
# install.packages("eyelinker")           # eyelink specific package
# install_github("alexander-pastukhov/eyelinkReader")                 # eyelink specific package
# install_github("aleksandernitka/EyeTracking_Tobii_VAS_IOHUB")  # eyelink specific package
# install.packages("gaze_analysis.R")     # for gaze analyses
# install.packages("report")              # to report results of anova
# install.packages("gazeR")                 # to preprocess eyetracking data
# install.packages("janitor")
# install.packages("multcomp")            # for multiple comparisons
# install.packages("lmerTest")            # for post-hoc tests of LMMs
# install.packages("JuliaCall")           # for coding in julia
# install.packages("sjPlot")              # for creating tables on LMM output
# install.packages("DT")                  # for creating datatables in R Markdown
```

**Load Packages**
```{r load packages, message=F, warning=F, include=F}
library("data.table")
library("writexl")
library("stats")
library("ggplot2")
library("tidyr")
library("dplyr")
library("report")
library("janitor")
library("lme4")
library("multcomp")
library("lmerTest")
library("JuliaCall")
library("sjPlot")
library("DT")
```

**Define the Colour Scheme**
```{r colour scheme, message=F, warning=F, include=F}
color1 <- "#003C6799"
color2 <- "#CD534C99"
color3 <- 'lightgoldenrod1'
color4 <- "darkseagreen"
```

# Install Julia
```{r install julia}
library(JuliaCall)
options(JULIA_HOME = "/Applications/Julia-1.11.app/Contents/Resources/julia/bin") # need to define the path for my Mac to resolve bug
j = julia_setup(installJulia = TRUE)
```

## Install Julia Packages
```{julia install julia packages, echo = F}
using Pkg
Pkg.activate(".")
Pkg.add(["MixedModels","JellyMe4","RCall"])
  
ENV["LMER"] ="lmerTest::lmer"
```

# Load Data 
```{r load data}
# data_dwelltime = read.csv("../data/data_dwelltime_OA.csv")
# data_entrytime = read.csv("../data/data_entrytime_OA.csv")
data_dwelltime = read.csv("/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/FilesAnalysis/data_dwelltime_OA.csv")
data_entrytime = read.csv("/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/FilesAnalysis/data_entrytime_OA.csv")

# Ensure participant IDs match between entry-time and dwell-time datasets
data_entrytime$participant = data_dwelltime$participant

# Set reaction time (rt) for the left stimulus using the first entry time to the lower-left position
data_entrytime$rt = data_entrytime$first_entry_time_left

# For trials where the right stimulus was fixated first, update reaction time with the first entry time to the upper-right position
ix_right = is.na(data_entrytime$first_entry_time_left)
data_entrytime$rt[ix_right] = data_entrytime$first_entry_time_right[ix_right]

# Determine which stimulus (lower-left or upper-right) was fixated first and store the corresponding stimulus ID (2 = left, 1 = right -> recoded to 0 = left, 1 = right)
data_entrytime$response = data_entrytime$first_entry_ID_left
data_entrytime$response[ix_right] = data_entrytime$first_entry_ID_right[ix_right]
data_entrytime <- data_entrytime %>%
  dplyr::mutate(response = ifelse(response == 2, 0,
                           ifelse(response == 1, 1, NA)))

# Set contrasts for stimuli attributes based on their positions (lower-left: -1, upper-right: +1
data_entrytime$ocd_left = data_entrytime$ocd_relevant_left == 1
data_entrytime$ocd_right = data_entrytime$ocd_relevant_right == 1

data_entrytime$pho_left = data_entrytime$spider_relevant_left == 1
data_entrytime$pho_right = data_entrytime$spider_relevant_right == 1

data_entrytime$neg_left = data_entrytime$negative_left == 1
data_entrytime$neg_right = data_entrytime$negative_right == 1

data_entrytime$neu_left = data_entrytime$neutral_left == 1
data_entrytime$neu_right = data_entrytime$neutral_right == 1

# Identify which direction the participant looked first (ir = upper-right, il = lower-left)
data_entrytime$looked_right = is.na(data_entrytime$first_entry_ID_left)
ir = data_entrytime$looked_right
il = !data_entrytime$looked_right

# Initialize columns to store the type of stimulus looked at and not looked at
data_entrytime$looked_at = 'neutral'
data_entrytime$not_looked_at = 'neutral'

# Set 'looked_at' based on whether the first fixation was on the lower-left or upper-right stimulus with specific attributes
ix = (il & data_entrytime$pho_left) | (ir & data_entrytime$pho_right)
data_entrytime$looked_at[ix] = "pho"

ix = (il & data_entrytime$ocd_left) | (ir & data_entrytime$ocd_right)
data_entrytime$looked_at[ix] = "ocd"

ix = (il & data_entrytime$neg_left) | (ir & data_entrytime$neg_right)
data_entrytime$looked_at[ix] = "neg"

# Set 'not_looked_at' based on the attribute of the stimulus that was not fixated on first
ix = (ir & data_entrytime$pho_left) | (il & data_entrytime$pho_right)
data_entrytime$not_looked_at[ix] = "pho"

ix = (ir & data_entrytime$ocd_left) | (il & data_entrytime$ocd_right)
data_entrytime$not_looked_at[ix] = "ocd"

ix = (ir & data_entrytime$neg_left) | (il & data_entrytime$neg_right)
data_entrytime$not_looked_at[ix] = "neg"
```

# Hypothesis 1: Maintenance Bias 
**From Complex to Simple Multilevel Models**
## Hypothesis 1: Create Models
```{r create julia models for H1}
#j $assign("form", formula(mlm_dwelltime))
j$assign("jl_data_dwelltime", data_dwelltime)
j$assign("jl_data_entrytime", data_entrytime)
julia_command("jl_data_entrytime.response .= jl_data_entrytime.response .-1")
julia_command("using MixedModels")
julia_command("using JellyMe4")
julia_command("using Pkg")
julia_command('Pkg.add("NLopt")')
julia_command("using NLopt")

# Model 4b: Exclude Triplet and Item
julia_command("h1_fm_excl_triplet_item = @formula(dwell_diff ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              (1 + stim_ocd + stim_pho + stim_neg | participant))")
```

## Hypothesis 1: Run Models 
```{r run julia models for H1}
julia_command("h1_fm_excl_triplet_item = fit(LinearMixedModel, h1_fm_excl_triplet_item, jl_data_dwelltime)")
```


## Hypothesis 1: Translate Models to R
```{r translate julia models for H1}
h1_fm_excl_triplet_item <- julia_eval("robject(:lmerMod, Tuple([h1_fm_excl_triplet_item,jl_data_dwelltime]));",need_return="R")
```

### Hypothesis 1: Evaluate Best Fitting Model 
```{r evaluate best fitting model H1}
summary(h1_fm_excl_triplet_item)
tab_model(h1_fm_excl_triplet_item)

# Export
tab_model(h1_fm_excl_triplet_item, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h1_fm_excl_triplet_item.doc")
```

## Hypothesis 1: Test of Hypotheses With Contrasts
To establish contrast codes that directly test the hypotheses, we first code the hypotheses we want to test. Then, we fit the established effects in the contrast() function. This function allows direct inspection of effects. The p-values are estimated by the Satterthwaite method. The p-values are unadjusted.

*Maintenance Bias:*
**a.**
Patients with *OCD* look at *idiosyncratic OCD-relevant material longer* compared to *neutral* or *negative* material (maintenance bias). 
**b.**
Patients with *OCD* will show a *more pronounced maintenance bias* compared to *healthy* participants and, with regard to *idiosyncratic disorder-specific material*, compared to patients with *spider phobia*.

```{r generalised hypotheses matrices}
# Define the model comparisons to test the specific hypothesis of hypothesis 2
g = (glht(h1_fm_excl_triplet_item, (c("
                                      stim_neg + groupocd:stim_neg >= 0", 
                                 # Patients with OCD look at negative material longer compared to neutral material (maintenance bias within group)
                                 "stim_ocd + groupocd:stim_ocd >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to neutral material (maintenance bias within group)
                            "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to negative material (maintenance bias within group)
                            "groupocd + groupocd:stim_ocd >= 0", # Patients with OCD will show a more pronounced maintenance bias compared to healthy participants (maintenance bias between groups)
                            "(groupocd + stim_ocd + groupocd:stim_ocd) -  (groupspider + stim_pho + groupspider:stim_pho) >= 0" # Patients with OCD will show a more pronounced maintenance to idiosyncratic disorder-specific material compared to patients with spider phobia (maintenance bias between group)
))))

# Satterthwaite is a more conservative method than the likelihood ratio test
# Likelihood ratio tests always compares two models with each other
# this is easy when the contrast is a treatment effect, but more difficult if we have three variables
# Deviation from preregistration - but this option is better, as
# 1. Contrasts are more easily to be implemented with contest(), as we have many different contrasts and three groups that we want to compare within- and between-subjects (LR would only allow two comparisons at a time)
# 2. Satterthwaite is more conservative than Likelihood Ratio Test
contest(h1_fm_excl_triplet_item,g$linfct,joint=FALSE,ddf="Satterthwaite")

rownames_h1_contrast <- c("stim_neg + groupocd:stim_neg", "stim_ocd + groupocd:stim_ocd","(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", "groupocd + groupocd:stim_ocd", "(groupocd + stim_ocd + groupocd:stim_ocd) - (groupspider + stim_pho + groupspider:stim_pho)")

h1_contrasts <- as.data.table(contest(h1_fm_excl_triplet_item,g$linfct,joint=FALSE,ddf="Satterthwaite"))
h1_contrasts <- h1_contrasts %>%
  dplyr::mutate(contrast = rownames_h1_contrast) %>%
  dplyr::relocate(contrast, .before = Estimate)
datatable(h1_contrasts)

# Export
write_xlsx(h1_contrasts, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/h1_contrasts.xlsx")
```


# Hypothesis 1 - Sensitivity Analysis: Exclduing 0 Fixations on AOI
```{r h1 sensitivity analysis - excl. 0 dwelltime}
data_dwelltime_excl0 <- data_dwelltime %>%
  dplyr::filter(!c(IA_FIXATION_COUNT_left == 0 | IA_FIXATION_COUNT_right == 0))

#j $assign("form", formula(mlm_dwelltime))
j$assign("jl_data_dwelltime_excl0", data_dwelltime_excl0)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h1_fm_excl_triplet_item_excl0 = @formula(dwell_diff ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              (1 + stim_ocd + stim_pho + stim_neg | participant))")

julia_command("h1_fm_excl_triplet_item_excl0 = fit(LinearMixedModel, h1_fm_excl_triplet_item_excl0, jl_data_dwelltime_excl0)")

h1_fm_excl_triplet_item_excl0 <- julia_eval("robject(:lmerMod, Tuple([h1_fm_excl_triplet_item_excl0,jl_data_dwelltime_excl0]));",need_return="R")

summary(h1_fm_excl_triplet_item_excl0)
tab_model(h1_fm_excl_triplet_item_excl0)

# Export
tab_model(h1_fm_excl_triplet_item_excl0, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h1_fm_excl_triplet_item_excl0.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g = (glht(h1_fm_excl_triplet_item_excl0, (c("stim_ocd + groupocd:stim_ocd >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to neutral material (maintenance bias within group)
                            "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to negative material (maintenance bias within group)
                            "groupocd + groupocd:stim_ocd >= 0", # Patients with OCD will show a more pronounced maintenance bias compared to healthy participants (maintenance bias between groups)
                            "(groupocd + stim_ocd + groupocd:stim_ocd) -  (groupspider + stim_pho + groupspider:stim_pho) >= 0" # Patients with OCD will show a more pronounced maintenance to idiosyncratic disorder-specific material compared to patients with spider phobia (maintenance bias between group)
))))

# Satterthwaite is a more conservative method than the likelihood ratio test
# Likelihood ratio tests always compares two models with each other
# this is easy when the contrast is a treatment effect, but more difficult if we have three variables
# Deviation from preregistration - but this option is better, as
# 1. Contrasts are more easily to be implemented with contest(), as we have many different contrasts and three groups that we want to compare within- and between-subjects (LR would only allow two comparisons at a time)
# 2. Satterthwaite is more conservative than Likelihood Ratio Test
contest(h1_fm_excl_triplet_item_excl0,g$linfct,joint=FALSE,ddf="Satterthwaite")

rownames_h1_contrast_excl0 <- c("stim_ocd + groupocd:stim_ocd","(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", "groupocd + groupocd:stim_ocd", "(groupocd + stim_ocd + groupocd:stim_ocd) - (groupspider + stim_pho + groupspider:stim_pho)")

h1_contrasts_excl0 <- as.data.table(contest(h1_fm_excl_triplet_item_excl0,g$linfct,joint=FALSE,ddf="Satterthwaite"))
h1_contrasts_excl0 <- h1_contrasts_excl0 %>%
  dplyr::mutate(contrast = rownames_h1_contrast_excl0) %>%
  dplyr::relocate(contrast, .before = Estimate)
datatable(h1_contrasts_excl0)

# Export
write_xlsx(h1_contrasts_excl0, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/h1_contrasts_excl0.xlsx")
```
Replicates results shown with total dataset. 


# Hypothesis 2: Vigilance Bias 
**From Complex to Simple Multilevel Models**
## Hypothesis 2a: Choice (wo Entry Time)
```{r create julia models for H2a choice}
# Model 4b: Exclude Triplet and Item
julia_command("h2a_glm_fm_excl_triplet_item = @formula(response ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg +
              (1 + stim_ocd + stim_pho| participant))")
```
#@Bene: Singularity Warning trotz zerocorr 

## Hypothesis 2a: Run Models 

```{julia define contrasts entrytime, include=FALSE}
using RCall
using MixedModels
using JellyMe4
jl_data_entrytime = @rget data_entrytime

c_entrytime = Dict(:group=>DummyCoding(;base="healthy"),:looked_right=>EffectsCoding(),:looked_at=>DummyCoding(;base="neutral"))
```

```{r run julia models for H2a}
julia_command("h2a_glm_fm_excl_triplet_item = fit(MixedModel, h2a_glm_fm_excl_triplet_item, jl_data_entrytime;contrasts=c_entrytime)")
```

## Hypothesis 2a: Translate Models to R
```{r translate julia models for H2a}
h2a_glm_fm_excl_triplet_item <- julia_eval("robject(:lmerMod, Tuple([h2a_glm_fm_excl_triplet_item,jl_data_entrytime]));",need_return="R")
```

### Evaluate Best Fitting Model 
```{r evaluate best fitting model H2a}
# best: h2a_glm_fm_excl_triplet_item
summary(h2a_glm_fm_excl_triplet_item)
tab_model(h2a_glm_fm_excl_triplet_item)

# Export 
tab_model(h2a_glm_fm_excl_triplet_item, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/summary_h2a_glm_fm_excl_triplet_item.doc")
```

## Hypothesis 2a: Test of Choice Hypothesis With Contrasts
To establish contrast codes that directly test the hypotheses, we first code the hypotheses we want to test. Then, we fit the established effects in the contrast() function. This function allows direct inspection of effects. The p-values are estimated by the Satterthwaite method. The p-values are unadjusted.

**Hypothesis:** 
Patients with **OCD** and patients with **spider phobia** attend to **idiosyncratic disorder-relevant material faster** than they do to **neutral** or **negative** material (vigilance bias), as indicated by the entry time to the corresponding region of interest. 
**Healthy participants** will **not show a bias** towards disorder-relevant stimuli compared to negative or neutral stimuli.

```{r h2a generalised hypotheses matrices}
# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2a_directional <- glht(h2a_glm_fm_excl_triplet_item, 
                      linfct = c("stim_ocd + groupocd:stim_ocd >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to neutral material
                                 
                                 "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to negative material
                                 
                                 "stim_pho + groupspider:stim_pho >= 0", 
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to neutral material
                                 "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg) >= 0"
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to negative material
                                 ))

g_h2a_equality <- glht(h2a_glm_fm_excl_triplet_item, 
                   linfct = c("stim_ocd = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli
                              
                              "stim_ocd - stim_neg = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to negative stimuli
                              
                              "stim_pho = 0", 
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli
                              
                              "stim_pho - stim_neg = 0"
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to negative stimuli
                   ))

# Contest Directional Hypotheses
contest(h2a_glm_fm_excl_triplet_item,g_h2a_directional$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2a_glm_fm_excl_triplet_item,g_h2a_equality$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2a_contrast_directional <- c("stim_ocd + groupocd:stim_ocd", 
                           "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", 
                           "stim_pho + groupspider:stim_pho",
                           "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg)")

rownames_h2a_contrast_equality <- c("stim_ocd", 
                                    "stim_ocd - stim_neg", 
                                    "stim_pho", 
                                    "stim_pho - stim_neg")

h2a_contrasts_directional <- as.data.table(contest(h2a_glm_fm_excl_triplet_item,g_h2a_directional$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_directional <- h2a_contrasts_directional %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_directional) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts_equality <- as.data.table(contest(h2a_glm_fm_excl_triplet_item,g_h2a_equality$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_equality <- h2a_contrasts_equality %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_equality) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts <- full_join(h2a_contrasts_directional, h2a_contrasts_equality)
datatable(h2a_contrasts)

# Export 
write_xlsx(h2a_contrasts, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/h2a_contrasts.xlsx")
```

# Hypothesis 2a - Sensitivity Analysis: Exclduing 0 Fixations on AOI
```{r h2a sensitivity analysis - excl. 0 dwelltime}
data_entrytime_excl0 <- data_entrytime %>%
  dplyr::filter(!c(IA_FIXATION_COUNT_left == 0 | IA_FIXATION_COUNT_right == 0))

#j $assign("form", formula(mlm_dwelltime))
j$assign("jl_data_entrytime_excl0", data_entrytime_excl0)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h2a_glm_fm_excl_triplet_item = @formula(response ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              (1 + stim_ocd + stim_pho | participant))")

julia_command("h2a_glm_fm_excl_triplet_item = fit(MixedModel, h2a_glm_fm_excl_triplet_item, jl_data_entrytime_excl0;contrasts=c_entrytime)")

h2a_glm_fm_excl_triplet_item_excl0 <- julia_eval("robject(:lmerMod, Tuple([h2a_glm_fm_excl_triplet_item,jl_data_entrytime_excl0]));",need_return="R")

summary(h2a_glm_fm_excl_triplet_item_excl0)
tab_model(h2a_glm_fm_excl_triplet_item_excl0)

# Export
tab_model(h2a_glm_fm_excl_triplet_item_excl0, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h2a_fm_excl_triplet_item_excl0.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2a_directional_excl0 <- glht(h2a_glm_fm_excl_triplet_item_excl0, 
                      linfct = c("stim_ocd + groupocd:stim_ocd >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to neutral material
                                 
                                 "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to negative material
                                 
                                 "stim_pho + groupspider:stim_pho >= 0", 
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to neutral material
                                 "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg) >= 0"
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to negative material
                                 ))

g_h2a_equality_excl0 <- glht(h2a_glm_fm_excl_triplet_item_excl0, 
                   linfct = c("stim_ocd = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli
                              
                              "stim_ocd - stim_neg = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to negative stimuli
                              
                              "stim_pho = 0", 
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli
                              
                              "stim_pho - stim_neg = 0"
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to negative stimuli
                   ))


# Contest Directional Hypotheses
contest(h2a_glm_fm_excl_triplet_item_excl0,g_h2a_directional_excl0$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2a_glm_fm_excl_triplet_item_excl0,g_h2a_equality_excl0$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2a_contrast_directional_excl0 <- c("stim_ocd + groupocd:stim_ocd", 
                           "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", 
                           "stim_pho + groupspider:stim_pho",
                           "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg)")

rownames_h2a_contrast_equality_excl0 <- c("stim_ocd", 
                                    "stim_ocd - stim_neg", 
                                    "stim_pho", 
                                    "stim_pho - stim_neg")

h2a_contrasts_directional_excl0 <- as.data.table(contest(h2a_glm_fm_excl_triplet_item_excl0,g_h2a_directional_excl0$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_directional_excl0 <- h2a_contrasts_directional_excl0 %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_directional_excl0) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts_equality_excl0 <- as.data.table(contest(h2a_glm_fm_excl_triplet_item_excl0,g_h2a_equality_excl0$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_equality_excl0 <- h2a_contrasts_equality_excl0 %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_equality_excl0) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts_excl0 <- full_join(h2a_contrasts_directional_excl0, h2a_contrasts_equality_excl0)
datatable(h2a_contrasts_excl0)

# Export 
write_xlsx(h2a_contrasts_excl0, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/h2a_contrasts_excl0.xlsx")
```
Different effect for spider pictures (exactly the opposite).


## Hypothesis 2b: Entry Time
```{r create julia models for H2b reaction time}

# Model 4b: Exclude Triplet and Item
# julia_command("h2b_fm_excl_triplet_item = @formula(rt ~ group*looked_at + looked_right*group+ 
              # (1 + looked_at + looked_right | participant))") 
julia_command("h2b_fm_excl_triplet_item = @formula(rt ~ group*looked_at + looked_right*group+ 
              (1 | participant))") # removed random slopes as the model (that was best-fitting) hat a singularity warning - zerocorr() did not remove the warning, removing one RS as well, so both were removed
```

## Hypothesis 2b: Run Models
```{julia define contrasts reaction time, include=FALSE}
using RCall
using MixedModels
using JellyMe4
jl_data_entrytime = @rget data_entrytime
                
c_rt = Dict(:group=>DummyCoding(;base="healthy"),:looked_right=>EffectsCoding(),:looked_at=>DummyCoding(;base="neutral"))
```


```{r run julia models for H2b}
julia_command("h2b_fm_excl_triplet_item = fit(LinearMixedModel, h2b_fm_excl_triplet_item, jl_data_entrytime;contrasts=c_rt)")
```

## Hypothesis 2b: Translate Models to R
```{r translate julia models for H2b}
h2b_fm_excl_triplet_item <- julia_eval("robject(:lmerMod, Tuple([h2b_fm_excl_triplet_item,jl_data_entrytime]));",need_return="R")
```

### Hypothesis 2b: Evaluate Best Fitting Model 
```{r evaluate best fitting model H2b}
# best: h2b_fm_excl_triplet_item
summary(h2b_fm_excl_triplet_item)
tab_model(h2b_fm_excl_triplet_item)

# Export 
tab_model(h2b_fm_excl_triplet_item, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/summary_h2b_fm_excl_triplet_item.doc")
```

## Hypothesis 2b: Test of Entry Time Hypothesis With Contrasts
**Hypothesis:**
Patients with **OCD** and patients with **spider phobia** attend to **idiosyncratic disorder-relevant material faster** than they do to **neutral** or **negative** material (vigilance bias), as indicated by the entry time to the corresponding region of interest. 
**Healthy participants** will **not show a bias** towards disorder-relevant stimuli compared to negative or neutral stimuli.

```{r h2b generalised hypotheses matrices}
# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2b_directional = (glht(h2b_fm_excl_triplet_item, (c("looked_atocd + groupocd:looked_atocd <= 0", # Patients with OCD fixate faster on idiosyncratic OCD-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg) <= 0", #Patients with OCD fixate faster on OCD-relevant material as compared to negative material (entry time bias within group)
                            "looked_atpho + groupspider:looked_atpho <= 0", # Patients with spider phobia fixate faster on idiosyncratic spider-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg) <= 0" # Patients with spider phobia fixate faster on spider-relevant material as compared to negative material (entry time bias within group
))))

g_h2b_equality = (glht(h2b_fm_excl_triplet_item, (c("looked_atocd = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                            "looked_atocd - looked_atneg = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho = 0", # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho - looked_atneg = 0" # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
))))

# Contest Directional Hypotheses
contest(h2b_fm_excl_triplet_item,g_h2b_directional$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2b_fm_excl_triplet_item,g_h2b_equality$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2b_contrast_directional <- c("looked_atocd + groupocd:looked_atocd", 
                                       "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg)", 
                                       "looked_atpho + groupspider:looked_atpho",
                                       "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg)")
rownames_h2b_contrast_equality <- c("looked_atocd",
                                    "looked_atocd - looked_atneg",
                                    "looked_atpho",
                                    "looked_atpho - looked_atneg")


h2b_contrasts_directional <- as.data.table(contest(h2b_fm_excl_triplet_item,g_h2b_directional$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_directional <- h2b_contrasts_directional %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_directional) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts_equality <- as.data.table(contest(h2b_fm_excl_triplet_item,g_h2b_equality$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_equality <- h2b_contrasts_equality %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_equality) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts <- full_join(h2b_contrasts_directional, h2b_contrasts_equality)
datatable(h2b_contrasts)

# Export
write_xlsx(h2b_contrasts, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/h2b_contrasts.xlsx")
```

# Plots
```{r plots for hypotheses}
# H1
h1_contrasts$names <- c("OCD - OCD-relevant (1) vs. neutral (0)", "OCD - OCD-relevant (1) vs. negative (0)", "OCD (1) vs. Non-Clinical (0) - OCD-relevant", "OCD (1) vs. Spider (0) - disorder-relevant")

h1_plot <- ggplot(h1_contrasts, aes(x = names, y = Estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) + 
  labs(title = "Dwell-Time Difference", y = "Dwell Time Difference (in ms)", x = "Contrasts") +
  theme(axis.text.x = element_text(angle = 45)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Apply 45-degree rotation to x-axis labels 

h1_plot

# H2a
h2a_contrasts$names <- c("OCD - OCD-relevant (0) vs. neutral (1)", "OCD - OCD-relevant (0) vs. negative (1)", 
                            "Spider - spider-relevant (0) vs. neutral (1)", "Spider - spider-relevant (0) vs. negative (1)", 
                            "Healthy - OCD-relevant (0) vs. neutra (1)l", "Healthy - OCD-relevant (0) vs. negative (1)",
                            "Healthy - spider-relevant (0) vs. neutral (1)", "Healthy - spider-relevant (0) vs. negative (1)")

h2a_contrasts <- h2a_contrasts %>%
  dplyr::mutate(Estimate_perc = Estimate*100)
h2a_plot <- ggplot(h2a_contrasts, aes(x = names, y = Estimate_perc)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = lower*100, ymax = upper*100), width = 0.2) + 
  labs(title = "First Fixation Choice", y = "Probability of First Fixation (in %)", x = "Contrasts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
h2a_plot

# H2b
h2b_contrasts$names <- c("OCD - OCD-relevant (1) vs. neutral (0)", "OCD - OCD-relevant (1) vs. negative (0)", 
                            "Spider - spider-relevant (1) vs. neutral (0)", "Spider - spider-relevant (1) vs. negative (0)", 
                            "Healthy - OCD-relevant (1) vs. neutral (0)", "Healthy - OCD-relevant (1) vs. negative (0)",
                            "Healthy - spider-relevant (1) vs. neutral (0)", "Healthy - spider-relevant (1) vs. negative (0)")

h2b_plot <- ggplot(h2b_contrasts, aes(x = names, y = Estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) + 
  labs(title = "First Fixation Latency", y = "First Fixation Latency (in ms)", x = "Contrasts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

h2b_plot
```


# Hypothesis 2b - Sensitivity Analysis: Exclduing 0 Fixations on AOI
```{r h2b sensitivity analysis - excl. 0 dwelltime}
data_entrytime_excl0 <- data_entrytime %>%
  dplyr::filter(!c(IA_FIXATION_COUNT_left == 0 | IA_FIXATION_COUNT_right == 0))

#j $assign("form", formula(mlm_dwelltime))
j$assign("jl_data_entrytime_excl0", data_entrytime_excl0)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h2b_fm_excl_triplet_item_excl0 = @formula(rt ~ group*looked_at + looked_right*group+ 
              (1 | participant))") # removed random slopes as the model (that was best-fitting) hat a singularity warning - zerocorr() did not remove the warning, removing one RS as well, so both were removed

julia_command("h2b_fm_excl_triplet_item_excl0 = fit(MixedModel, h2b_fm_excl_triplet_item_excl0, jl_data_entrytime_excl0;contrasts=c_entrytime)")

h2b_fm_excl_triplet_item_excl0 <- julia_eval("robject(:lmerMod, Tuple([h2b_fm_excl_triplet_item_excl0,jl_data_entrytime_excl0]));",need_return="R")

summary(h2b_fm_excl_triplet_item_excl0)
tab_model(h2b_fm_excl_triplet_item_excl0)

# Export
tab_model(h2b_fm_excl_triplet_item_excl0, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h2b_fm_excl_triplet_item_excl0.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2b_directional_excl0 = (glht(h2b_fm_excl_triplet_item_excl0, (c("looked_atocd + groupocd:looked_atocd <= 0", # Patients with OCD fixate faster on idiosyncratic OCD-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg) <= 0", #Patients with OCD fixate faster on OCD-relevant material as compared to negative material (entry time bias within group)
                            "looked_atpho + groupspider:looked_atpho <= 0", # Patients with spider phobia fixate faster on idiosyncratic spider-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg) <= 0" # Patients with spider phobia fixate faster on spider-relevant material as compared to negative material (entry time bias within group
))))

g_h2b_equality_excl0 = (glht(h2b_fm_excl_triplet_item_excl0, (c("looked_atocd = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                            "looked_atocd - looked_atneg = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho = 0", # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho - looked_atneg = 0" # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
))))


# Contest Directional Hypotheses
contest(h2b_fm_excl_triplet_item_excl0,g_h2b_directional_excl0$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2b_fm_excl_triplet_item_excl0,g_h2b_equality_excl0$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2b_contrast_directional_excl0 <- c("looked_atocd + groupocd:looked_atocd", 
                                       "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg)", 
                                       "looked_atpho + groupspider:looked_atpho",
                                       "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg)")
rownames_h2b_contrast_equality_excl0 <- c("looked_atocd",
                                    "looked_atocd - looked_atneg",
                                    "looked_atpho",
                                    "looked_atpho - looked_atneg")
    
h2b_contrasts_directional_excl0 <- as.data.table(contest(h2b_fm_excl_triplet_item_excl0,g_h2b_directional_excl0$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_directional_excl0 <- h2b_contrasts_directional_excl0 %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_directional_excl0) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts_equality_excl0 <- as.data.table(contest(h2b_fm_excl_triplet_item_excl0,g_h2b_equality_excl0$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_equality_excl0 <- h2b_contrasts_equality_excl0 %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_equality_excl0) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts_excl0 <- full_join(h2b_contrasts_directional_excl0, h2b_contrasts_equality_excl0)
datatable(h2b_contrasts_excl0)

# Export 
write_xlsx(h2b_contrasts_excl0, "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/VigilanceBias/h2b_contrasts_excl0.xlsx")
```
Could replicate results of total dataset. 

# Check Contrast Coding
## Check Contrast Coding for H1
```{r check contrast coding for H1}
data_dwelltime_checkcontrast <- data_dwelltime %>%
  # For OCD vs. Negative
   dplyr::mutate(dwell_diff = ifelse(group == "ocd" & (ocd_relevant_right == 1 & negative_left == 1), dwell_diff - 1000, dwell_diff),
                dwell_diff = ifelse(group == "ocd" & (ocd_relevant_left == 1 & negative_right == 1), dwell_diff + 1000, dwell_diff))
  # For OCD vs. Neutral
    # dplyr::mutate(dwell_diff = ifelse(group == "ocd" & (ocd_relevant_right == 1 & neutral_left == 1), dwell_diff - 500, dwell_diff),
    #               dwell_diff = ifelse(group == "ocd" & (ocd_relevant_left == 1 & neutral_right == 10), dwell_diff + 500, dwell_diff))

j$assign("jl_data_dwelltime_checkcontrast", data_dwelltime_checkcontrast)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h1_fm_excl_triplet_item_checkcontrast = @formula(dwell_diff ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              (1 + stim_ocd + stim_pho + stim_neg | participant))")

julia_command("h1_fm_excl_triplet_item_checkcontrast = fit(LinearMixedModel, h1_fm_excl_triplet_item_checkcontrast, jl_data_dwelltime_checkcontrast)")

h1_fm_excl_triplet_item_checkcontrast <- julia_eval("robject(:lmerMod, Tuple([h1_fm_excl_triplet_item_checkcontrast,jl_data_dwelltime_checkcontrast]));",need_return="R")

summary(h1_fm_excl_triplet_item_checkcontrast)
tab_model(h1_fm_excl_triplet_item_checkcontrast)

# Export
tab_model(h1_fm_excl_triplet_item_checkcontrast, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h1_fm_excl_triplet_item_checkcontrast.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g = (glht(h1_fm_excl_triplet_item_checkcontrast, (c("stim_ocd + groupocd:stim_ocd >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to neutral material (maintenance bias within group)
                            "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to negative material (maintenance bias within group)
                            "groupocd + groupocd:stim_ocd >= 0", # Patients with OCD will show a more pronounced maintenance bias compared to healthy participants (maintenance bias between groups)
                            "(groupocd + stim_ocd + groupocd:stim_ocd) -  (groupspider + stim_pho + groupspider:stim_pho) >= 0" # Patients with OCD will show a more pronounced maintenance to idiosyncratic disorder-specific material compared to patients with spider phobia (maintenance bias between group)
))))

# Satterthwaite is a more conservative method than the likelihood ratio test
# Likelihood ratio tests always compares two models with each other
# this is easy when the contrast is a treatment effect, but more difficult if we have three variables
# Deviation from preregistration - but this option is better, as
# 1. Contrasts are more easily to be implemented with contest(), as we have many different contrasts and three groups that we want to compare within- and between-subjects (LR would only allow two comparisons at a time)
# 2. Satterthwaite is more conservative than Likelihood Ratio Test
contest(h1_fm_excl_triplet_item_checkcontrast,g$linfct,joint=FALSE,ddf="Satterthwaite")

rownames_h1_contrast_checkcontrast <- c("stim_ocd + groupocd:stim_ocd","(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", "groupocd + groupocd:stim_ocd", "(groupocd + stim_ocd + groupocd:stim_ocd) - (groupspider + stim_pho + groupspider:stim_pho)")

h1_contrasts_checkcontrast <- as.data.table(contest(h1_fm_excl_triplet_item_checkcontrast,g$linfct,joint=FALSE,ddf="Satterthwaite"))
h1_contrasts_checkcontrast <- h1_contrasts_checkcontrast %>%
  dplyr::mutate(contrast = rownames_h1_contrast_checkcontrast) %>%
  dplyr::relocate(contrast, .before = Estimate)
datatable(h1_contrasts)
datatable(h1_contrasts_checkcontrast)
```


## Check Contrast Coding for H2a
```{r check contrast coding for H2a}
data_entrytime_checkcontrast <- data_entrytime %>%
  # # For OCD vs. Negative
  # dplyr::mutate(response = ifelse(group == "ocd" & (stim_ocd == 1 & stim_neg == -1), 1, response), 
  #               response = ifelse(group == "ocd" & (stim_ocd == -1 & stim_neg == 1), 0, response))
  # For OCD vs. Neutral
    dplyr::mutate(response = ifelse(group == "ocd" & (stim_ocd == 1 & stim_neg == 0 & stim_pho == 0), 1, response),
                  response = ifelse(group == "ocd" & (stim_ocd == -1 & stim_neg == 0 & stim_pho == 0), 0, response))

#j $assign("form", formula(mlm_dwelltime))
j$assign("jl_data_entrytime_checkcontrast", data_entrytime_checkcontrast)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h2a_glm_fm_excl_triplet_item = @formula(response ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              zerocorr(1 + stim_ocd + stim_pho + stim_neg | participant))")

julia_command("h2a_glm_fm_excl_triplet_item = fit(MixedModel, h2a_glm_fm_excl_triplet_item, jl_data_entrytime_checkcontrast;contrasts=c_entrytime)")

h2a_glm_fm_excl_triplet_item_checkcontrast <- julia_eval("robject(:lmerMod, Tuple([h2a_glm_fm_excl_triplet_item,jl_data_entrytime_checkcontrast]));",need_return="R")

summary(h2a_glm_fm_excl_triplet_item_checkcontrast)
tab_model(h2a_glm_fm_excl_triplet_item_checkcontrast)

# Export
tab_model(h2a_glm_fm_excl_triplet_item_checkcontrast, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h2a_fm_excl_triplet_item_checkcontrast.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2a_directional_checkcontrast <- glht(h2a_glm_fm_excl_triplet_item_checkcontrast, 
                      linfct = c("stim_ocd + groupocd:stim_ocd >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to neutral material
                                 
                                 "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", 
                                 # Patients with OCD are more likely to first fixate on OCD-relevant material compared to negative material
                                 
                                 "stim_pho + groupspider:stim_pho >= 0", 
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to neutral material
                                 "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg) >= 0"
                                 # Patients with spider phobia are more likely to first fixate on spider-relevant material compared to negative material
                                 ))

g_h2a_equality_checkcontrast <- glht(h2a_glm_fm_excl_triplet_item_checkcontrast, 
                   linfct = c("stim_ocd = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli
                              
                              "stim_ocd - stim_neg = 0", 
                              # Healthy participants will not show a bias towards OCD-relevant stimuli compared to negative stimuli
                              
                              "stim_pho = 0", 
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli
                              
                              "stim_pho - stim_neg = 0"
                              # Healthy participants will not show a bias towards spider-relevant stimuli compared to negative stimuli
                   ))


# Contest Directional Hypotheses
contest(h2a_glm_fm_excl_triplet_item_checkcontrast,g_h2a_directional_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2a_glm_fm_excl_triplet_item_checkcontrast,g_h2a_equality_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2a_contrast_directional_checkcontrast <- c("stim_ocd + groupocd:stim_ocd", 
                           "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", 
                           "stim_pho + groupspider:stim_pho",
                           "(stim_pho + groupspider:stim_pho) - (stim_neg + groupspider:stim_neg)")

rownames_h2a_contrast_equality_checkcontrast <- c("stim_ocd", 
                                    "stim_ocd - stim_neg", 
                                    "stim_pho", 
                                    "stim_pho - stim_neg")

h2a_contrasts_directional_checkcontrast <- as.data.table(contest(h2a_glm_fm_excl_triplet_item_checkcontrast,g_h2a_directional_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_directional_checkcontrast <- h2a_contrasts_directional_checkcontrast %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_directional_checkcontrast) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts_equality_checkcontrast <- as.data.table(contest(h2a_glm_fm_excl_triplet_item_checkcontrast,g_h2a_equality_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite"))
h2a_contrasts_equality_checkcontrast <- h2a_contrasts_equality_checkcontrast %>%
  dplyr::mutate(contrast = rownames_h2a_contrast_equality_checkcontrast) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2a_contrasts_checkcontrast <- full_join(h2a_contrasts_directional_checkcontrast, h2a_contrasts_equality_checkcontrast)
# Old Contrast
h2a_contrasts
# Adjusted Contrast 
h2a_contrasts_checkcontrast
```
# Sowohl negative als auch neutral werden hier deutlich sig. wenn ich justiere, dass OCD immer angeschaut wird, wenn daneben neutral / negative presentiert wird

## Check Contrast Coding for H2b
```{r check contrast coding for H2b}
data_entrytime_checkcontrast_h2b <- data_entrytime %>%
  # For OCD vs. Negative
  dplyr::mutate(rt = ifelse(group == "ocd" & (stim_ocd == 1 & stim_neg == -1), rt + 300, rt),
                rt = ifelse(group == "ocd" & (stim_ocd == -1 & stim_neg == 1), rt - 300, rt))
  # For OCD vs. Neutral
    # dplyr::mutate(rt = ifelse(group == "ocd" & (stim_ocd == 1 & stim_neg == 0 & stim_pho == 0), rt + 300, rt),
    #               rt = ifelse(group == "ocd" & (stim_ocd == -1 & stim_neg == 0 & stim_pho == 0), rt - 300, rt))


j$assign("jl_data_entrytime_checkcontrast", data_entrytime_checkcontrast_h2b)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h2b_fm_excl_triplet_item_checkcontrast = @formula(rt ~ group*looked_at + looked_right*group+ 
              (1 | participant))") # removed random slopes as the model (that was best-fitting) hat a singularity warning - zerocorr() did not remove the warning, removing one RS as well, so both were removed

julia_command("h2b_fm_excl_triplet_item_checkcontrast = fit(MixedModel, h2b_fm_excl_triplet_item_checkcontrast, jl_data_entrytime_checkcontrast;contrasts=c_entrytime)")

h2b_fm_excl_triplet_item_checkcontrast <- julia_eval("robject(:lmerMod, Tuple([h2b_fm_excl_triplet_item_checkcontrast,jl_data_entrytime_checkcontrast]));",need_return="R")

summary(h2b_fm_excl_triplet_item_checkcontrast)
tab_model(h2b_fm_excl_triplet_item_checkcontrast)

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g_h2b_directional_checkcontrast = (glht(h2b_fm_excl_triplet_item_checkcontrast, (c("looked_atocd + groupocd:looked_atocd <= 0", # Patients with OCD fixate faster on idiosyncratic OCD-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg) <= 0", #Patients with OCD fixate faster on OCD-relevant material as compared to negative material (entry time bias within group)
                            "looked_atpho + groupspider:looked_atpho <= 0", # Patients with spider phobia fixate faster on idiosyncratic spider-relevant material as compared to neutral material (entry time bias within group)
                            "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg) <= 0" # Patients with spider phobia fixate faster on spider-relevant material as compared to negative material (entry time bias within group
))))

g_h2b_equality_checkcontrast = (glht(h2b_fm_excl_triplet_item_checkcontrast, (c("looked_atocd = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                            "looked_atocd - looked_atneg = 0", # Healthy participants will not show a bias towards OCD-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho = 0", # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
                              "looked_atpho - looked_atneg = 0" # Healthy participants will not show a bias towards spider-relevant stimuli compared to neutral stimuli (entry time bias within healthy group)
))))


# Contest Directional Hypotheses
contest(h2b_fm_excl_triplet_item_checkcontrast,g_h2b_directional_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite")

# Contest Equality Hypotheses
contest(h2b_fm_excl_triplet_item_checkcontrast,g_h2b_equality_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite")

# Create Data Tables 
rownames_h2b_contrast_directional_checkcontrast <- c("looked_atocd + groupocd:looked_atocd", 
                                       "(looked_atocd + groupocd:looked_atocd) - (looked_atneg + groupocd:looked_atneg)", 
                                       "looked_atpho + groupspider:looked_atpho",
                                       "(looked_atpho + groupspider:looked_atpho) - (looked_atneg + groupspider:looked_atneg)")
rownames_h2b_contrast_equality_checkcontrast <- c("looked_atocd",
                                    "looked_atocd - looked_atneg",
                                    "looked_atpho",
                                    "looked_atpho - looked_atneg")
    
h2b_contrasts_directional_checkcontrast <- as.data.table(contest(h2b_fm_excl_triplet_item_checkcontrast,g_h2b_directional_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_directional_checkcontrast <- h2b_contrasts_directional_checkcontrast %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_directional_checkcontrast) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts_equality_checkcontrast <- as.data.table(contest(h2b_fm_excl_triplet_item_checkcontrast,g_h2b_equality_checkcontrast$linfct,joint=FALSE,ddf="Satterthwaite"))
h2b_contrasts_equality_checkcontrast <- h2b_contrasts_equality_checkcontrast %>%
  dplyr::mutate(contrast = rownames_h2b_contrast_equality_checkcontrast) %>%
  dplyr::relocate(contrast, .before = Estimate)

h2b_contrasts_checkcontrast <- full_join(h2b_contrasts_directional_checkcontrast, h2b_contrasts_equality_checkcontrast)

# Original Contrast
h2b_contrasts

# Adjusted Contrast
h2b_contrasts_checkcontrast
```

# Slides OCD and Spider Relevant on Opposing Sites
The coding is now as follows: 
for OCD participant, the rating of the other (spider-relevant) picture will be valence-based
```{r slides ocd and spider relevant on opposing slides}
potentially_problematic <- data_dwelltime %>%
  dplyr::mutate(spider_and_ocd = ifelse((stim_ocd == 1 & stim_pho == -1 ) | (stim_ocd == -1 & stim_pho == 1), 1, 0))

potentially_problematic <- potentially_problematic %>%
  dplyr::filter(spider_and_ocd == 1)
length(potentially_problematic$participant)
```
# Sowohl negative als auch neutral werden hier deutlich sig. wenn ich justiere, dass OCD immer angeschaut wird, wenn daneben neutral / negative presentiert wird

# H1 Without Potentially Problematic Slides
```{r h1 without potentially problematic slides}
data_dwelltime_wo_pp <- anti_join(data_dwelltime, potentially_problematic)

j$assign("jl_data_dwelltime_wo_pp", data_dwelltime_wo_pp)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("h1_fm_excl_triplet_item_wo_pp = @formula(dwell_diff ~ group + stim_ocd + stim_pho + stim_neg + group&stim_ocd + group&stim_pho + group&stim_neg + 
              (1 + stim_ocd + stim_pho + stim_neg | participant))")

julia_command("h1_fm_excl_triplet_item_wo_pp = fit(LinearMixedModel, h1_fm_excl_triplet_item_wo_pp, jl_data_dwelltime_wo_pp)")

h1_fm_excl_triplet_item_wo_pp <- julia_eval("robject(:lmerMod, Tuple([h1_fm_excl_triplet_item_wo_pp,jl_data_dwelltime_wo_pp]));",need_return="R")

summary(h1_fm_excl_triplet_item_wo_pp)
tab_model(h1_fm_excl_triplet_item_wo_pp)

# Export
tab_model(h1_fm_excl_triplet_item_wo_pp, file = "/Volumes/109-psy-kp-study/044_EYE/06_Results/02_Hauptstudie/MaintenanceBias/summary_h1_fm_excl_triplet_item_wo_pp.doc")

# Define the model comparisons to test the specific hypothesis of hypothesis 2
g = (glht(h1_fm_excl_triplet_item_wo_pp, (c("stim_ocd + groupocd:stim_ocd >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to neutral material (maintenance bias within group)
                            "(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg) >= 0", # Patients with OCD look at idiosyncratic OCD-relevant material longer compared to negative material (maintenance bias within group)
                            "groupocd + groupocd:stim_ocd >= 0", # Patients with OCD will show a more pronounced maintenance bias compared to healthy participants (maintenance bias between groups)
                            "(groupocd + stim_ocd + groupocd:stim_ocd) -  (groupspider + stim_pho + groupspider:stim_pho) >= 0" # Patients with OCD will show a more pronounced maintenance to idiosyncratic disorder-specific material compared to patients with spider phobia (maintenance bias between group)
))))

# Satterthwaite is a more conservative method than the likelihood ratio test
# Likelihood ratio tests always compares two models with each other
# this is easy when the contrast is a treatment effect, but more difficult if we have three variables
# Deviation from preregistration - but this option is better, as
# 1. Contrasts are more easily to be implemented with contest(), as we have many different contrasts and three groups that we want to compare within- and between-subjects (LR would only allow two comparisons at a time)
# 2. Satterthwaite is more conservative than Likelihood Ratio Test
contest(h1_fm_excl_triplet_item_wo_pp,g$linfct,joint=FALSE,ddf="Satterthwaite")

rownames_h1_contrast_wo_pp <- c("stim_ocd + groupocd:stim_ocd","(stim_ocd + groupocd:stim_ocd) - (stim_neg + groupocd:stim_neg)", "groupocd + groupocd:stim_ocd", "(groupocd + stim_ocd + groupocd:stim_ocd) - (groupspider + stim_pho + groupspider:stim_pho)")

h1_contrasts_wo_pp <- as.data.table(contest(h1_fm_excl_triplet_item_wo_pp,g$linfct,joint=FALSE,ddf="Satterthwaite"))
h1_contrasts_wo_pp <- h1_contrasts_wo_pp %>%
  dplyr::mutate(contrast = rownames_h1_contrast_wo_pp) %>%
  dplyr::relocate(contrast, .before = Estimate)
datatable(h1_contrasts)
datatable(h1_contrasts_wo_pp)
```


```{r check distribution of first fixation choice}
j$assign("jl_data_entrytime", data_entrytime)
julia_command("using MixedModels")
julia_command("using JellyMe4")

# Model 4b: Exclude Triplet and Item
julia_command("choice_leftright = @formula(response ~ 1 + stim_neu +
              (1 | participant))")

julia_command("choice_leftright = fit(MixedModel, choice_leftright, jl_data_entrytime)")

choice_leftright <- julia_eval("robject(:lmerMod, Tuple([choice_leftright,jl_data_entrytime]));",need_return="R")

summary(choice_leftright)
tab_model(choice_leftright)

left_right_choice <- data_entrytime %>%
  dplyr::mutate(ocd_negative = ifelse((stim_ocd == 1 & stim_neg == -1 & response == 1) | (stim_ocd == -1 & stim_neg == 1 & response == 0), "ocdfirst", 
                                           ifelse((stim_ocd == 1 & stim_neg == -1 & response == 0) | (stim_ocd == -1 & stim_neg == 1 & response == 1), "negativefirst", NA)),
                ocd_neutral = ifelse((stim_ocd == 1 & stim_neu == -1 & response == 1) | (stim_ocd == -1 & stim_neu == 1 & response == 0), "ocdfirst", 
                                           ifelse((stim_ocd == 1 & stim_neu == -1 & response == 0) | (stim_ocd == -1 & stim_neu == 1 & response == 1), "neutralfirst", NA)),
                pho_negative = ifelse((stim_pho == 1 & stim_neg == -1 & response == 1) | (stim_pho == -1 & stim_neg == 1 & response == 0), "phofirst", 
                                           ifelse((stim_pho == 1 & stim_neg == -1 & response == 0) | (stim_pho == -1 & stim_neg == 1 & response == 1), "negativefirst", NA)),
                pho_neutral = ifelse((stim_pho == 1 & stim_neu == -1 & response == 1) | (stim_pho == -1 & stim_neu == 1 & response == 0), "phofirst", 
                                           ifelse((stim_pho == 1 & stim_neu == -1 & response == 0) | (stim_pho == -1 & stim_neu == 1 & response == 1), "neutralfirst", NA)))
table(left_right_choice$group, left_right_choice$ocd_negative)
table(left_right_choice$group, left_right_choice$ocd_neutral)
table(left_right_choice$group, left_right_choice$pho_negative)
table(left_right_choice$group, left_right_choice$pho_neutral)

# Left Bias:
table(data_entrytime$first_entry_ID_left) / (table(data_entrytime$first_entry_ID_left) + table(data_entrytime$first_entry_ID_right))
```

